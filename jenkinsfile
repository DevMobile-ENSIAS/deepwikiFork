pipeline {
    agent any

    environment {
        DOCKER_USER = 'imanebenabbou'
        IMAGE_TAG   = 'latest'
        SERVICES    = "auth-service,dashboard,entreprise,gateway,mission-service,spacecraft,telemetry"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Push Images') {
            steps {
                script {
                    def svcList = SERVICES.tokenize(',')
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        svcList.each { service ->
                            echo "Building and pushing ${service}"
                            // Each bat invocation is a single shell session on Windows
                            bat """
                                docker build -f Dockerfile -t %DOCKER_USER%/${service}:%IMAGE_TAG% .
                                docker login -u %DOCKER_USER% -p %DOCKER_PASS%
                                docker push %DOCKER_USER%/${service}:%IMAGE_TAG%
                            """
                        }
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    withCredentials([file(
                        credentialsId: 'kubeconfig-production',
                        variable: 'KUBECONFIG'
                    )]) {
                        bat """
                            echo Applying all Kubernetes manifests...
                            kubectl --kubeconfig="%KUBECONFIG%" apply -f k8s\\
                        """
                    }
                }
            }
        }
    }
}
