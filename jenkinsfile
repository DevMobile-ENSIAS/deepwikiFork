stage('Build, Push and Deploy Services') {
  steps {
    script {
      def services = [
        'auth-service','dashboard','entreprise',
        'gateway','mission-service','spacecraft','telemetry'
      ]

      // Build & push images
      services.each { svc ->
        echo "→ Building & pushing ${svc}"
        bat "docker build -t %DOCKER_USER%/${svc}:${IMAGE_TAG} ."
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub-credentials',
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          bat """
            docker login -u %DOCKER_USER% -p %DOCKER_PASS%
            docker push %DOCKER_USER%/${svc}:${IMAGE_TAG}
          """
        }
      }

      // Deploy all manifests in k8s/ at once
      echo "→ Applying all k8s manifests"
      bat """
        set KUBECONFIG=C:\\Users\\DELL\\.kube\\config
        kubectl apply -f k8s/
      """

      // Wait for each deployment to roll out
      services.each { svc ->
        echo "→ Waiting rollout of ${svc}"
        bat "kubectl rollout status deployment/${svc}"
      }
    }
  }
}